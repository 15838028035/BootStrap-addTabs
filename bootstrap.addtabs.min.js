/**
 * Website: http://git.oschina.net/hbbcs/bootStrap-addTabs
 *
 * Version : 1.5
 *
 * Created by joe on 2016-2-4.
 */
$.fn.addtabs=function(options){Addtabs.options=$.extend({content:"",close:true,monitor:"body",iframeUse:true,iframeHeight:$(document).height()-107,method:"init",contextmenu:true,obj:$(this),local:{"refreshLabel":"刷新此标签","closeThisLabel":"关闭此标签","closeOtherLabel":"关闭其他标签","closeLeftLabel":"关闭左侧标签","closeRightLabel":"关闭右侧标签"},callback:function(){}},options||{});$(Addtabs.options.monitor).on("click","[data-addtab]",function(){Addtabs.add({id:$(this).attr("data-addtab"),title:$(this).attr("title")?$(this).attr("title"):$(this).html(),content:Addtabs.options.content?Addtabs.options.content:$(this).attr("content"),url:$(this).attr("url"),ajax:$(this).attr("ajax")?true:false})});Addtabs.options.obj.on("click",".close-tab",function(){var id=$(this).prev("a").attr("aria-controls");Addtabs.close(id)});if(Addtabs.options.contextmenu){Addtabs.options.obj.on("contextmenu","li[role=presentation]",function(){var id=$(this).children("a").attr("aria-controls");Addtabs.pop(id,$(this));return false});Addtabs.options.obj.on("click","ul.rightMenu a[data-right=refresh]",function(){var id=$(this).parent("ul").attr("aria-controls").substring(4);var url=$(this).parent("ul").attr("aria-url");Addtabs.add({"id":id,"url":url,"refresh":true})});Addtabs.options.obj.on("click","ul.rightMenu a[data-right=remove]",function(){var id=$(this).parent("ul").attr("aria-controls");if(id.substring(0,4)!="tab_"){return}Addtabs.close(id);Addtabs.drop()});Addtabs.options.obj.on("click","ul.rightMenu a[data-right=remove-circle]",function(){var tab_id=$(this).parent("ul").attr("aria-controls");Addtabs.options.obj.children("ul.nav").find("li").each(function(){var id=$(this).attr("id");if(id&&id!="tab_"+tab_id){Addtabs.close($(this).children("a").attr("aria-controls"))}});Addtabs.drop()});Addtabs.options.obj.on("click","ul.rightMenu a[data-right=remove-left]",function(){var tab_id=$(this).parent("ul").attr("aria-controls");$("#tab_"+tab_id).prevUntil().each(function(){var id=$(this).attr("id");if(id&&id!="tab_"+tab_id){Addtabs.close($(this).children("a").attr("aria-controls"))}});Addtabs.drop()});Addtabs.options.obj.on("click","ul.rightMenu a[data-right=remove-right]",function(){var tab_id=$(this).parent("ul").attr("aria-controls");$("#tab_"+tab_id).nextUntil().each(function(){var id=$(this).attr("id");if(id&&id!="tab_"+tab_id){Addtabs.close($(this).children("a").attr("aria-controls"))}});Addtabs.drop()})}Addtabs.options.obj.on("mouseover",'li[role = "presentation"]',function(){$(this).find(".close-tab").show()});Addtabs.options.obj.on("mouseleave",'li[role = "presentation"]',function(){$(this).find(".close-tab").hide()});$(window).resize(function(){Addtabs.options.obj.find("iframe").attr("height",Addtabs.options.iframeHeight);Addtabs.drop()})};window.Addtabs={options:{},add:function(opts){var id="tab_"+opts.id;$('li[role = "presentation"].active').removeClass("active");$('div[role = "tabpanel"].active').removeClass("active");if(!$("#"+id).length){var title=$("<li>",{"role":"presentation","id":"tab_"+id,"aria-url":opts.url,"draggable":true}).append($("<a>",{"href":"#"+id,"aria-controls":id,"role":"tab","data-toggle":"tab"}).html(opts.title));if(Addtabs.options.close){title.append($("<i>",{"class":"close-tab glyphicon glyphicon-remove"}))}var content=$("<div>",{"class":"tab-pane","id":id,"role":"tabpanel"});Addtabs.options.obj.children(".nav-tabs").append(title);Addtabs.options.obj.children(".tab-content").append(content)}else{if(!opts.refresh){$("#tab_"+id).addClass("active");$("#"+id).addClass("active");Addtabs.drop();return}else{var content=$("#"+id);content.html("")}}if(opts.content){content.append(opts.content)}else{if(Addtabs.options.iframeUse&&!opts.ajax){content.append($("<iframe>",{"class":"iframeClass","height":Addtabs.options.iframeHeight,"frameborder":"no","border":"0","src":opts.url}))}else{$.get(opts.url,function(data){content.append(data)})}}$("#tab_"+id).addClass("active");$("#"+id).addClass("active");Addtabs.drop()},pop:function(id,e){$("body").find("#popMenu").remove();var refresh=e.attr("id")?'<a href="javascript:void(0);" class="list-group-item" data-right="refresh"><i class="glyphicon glyphicon-refresh"></i> '+Addtabs.options.local.refreshLabel+"</a>"+'<a href="javascript:void(0);" class="list-group-item" data-right="remove"><i class="glyphicon glyphicon-remove"></i> '+Addtabs.options.local.closeThisLabel+"</a>":"";var left=e.prev("li").attr("id")?'<a href="javascript:void(0);" class="list-group-item" data-right="remove-left"><i class="glyphicon glyphicon-chevron-left"></i> '+Addtabs.options.local.closeLeftLabel+"</a>":"";var right=e.next("li").attr("id")?'<a href="javascript:void(0);" class="list-group-item" data-right="remove-right"><i class="glyphicon glyphicon-chevron-right"></i> '+Addtabs.options.local.closeRightLabel+"</a>":"";var popHtml=$("<ul>",{"aria-controls":id,"class":"rightMenu list-group",id:"popMenu","aria-url":e.attr("aria-url")}).append(refresh+'<a href="javascript:void(0);" class="list-group-item" data-right="remove-circle"><i class="glyphicon glyphicon-remove-circle"></i> '+Addtabs.options.local.closeOtherLabel+"</a>"+left+right);popHtml.css({"top":e[0].offsetHeight-10+"px","left":e[0].offsetLeft+50+"px"});popHtml.appendTo(Addtabs.options.obj).fadeIn("slow");popHtml.mouseleave(function(){$(this).fadeOut("slow")});$("body").click(function(){popHtml.fadeOut("slow")})},close:function(id){if(Addtabs.options.obj.find("li.active").attr("id")==="tab_"+id){$("#tab_"+id).prev().addClass("active");$("#"+id).prev().addClass("active")}$("#tab_"+id).remove();$("#"+id).remove();Addtabs.drop();Addtabs.options.callback()},closeAll:function(){$.each(obj.find("li[id]"),function(){var id=$(this).children("a").attr("aria-controls");$("#tab_"+id).remove();$("#"+id).remove()});Addtabs.options.obj.find('li[role = "presentation"]').first().addClass("active");var firstID=obj.find('li[role = "presentation"]').first().children("a").attr("aria-controls");$("#"+firstID).addClass("active");Addtabs.drop()},drop:function(){element=Addtabs.options.obj.find(".nav-tabs");var dropdown=$("<li>",{"class":"dropdown pull-right hide tabdrop tab-drop"}).append($("<a>",{"class":"dropdown-toggle","data-toggle":"dropdown","href":"#"}).append($("<i>",{"class":"glyphicon glyphicon-align-justify"})).append($("<b>",{"class":"caret"}))).append($("<ul>",{"class":"dropdown-menu"}));if(!$(".tabdrop").html()){dropdown.prependTo(element)}else{dropdown=element.find(".tabdrop")}if(element.parent().is(".tabs-below")){dropdown.addClass("dropup")}var collection=0;element.append(dropdown.find("li")).find(">li").not(".tabdrop").each(function(){if(this.offsetTop>0||element.width()-$(this).position().left-$(this).width()<83){dropdown.find("ul").prepend($(this));collection++}});if(collection>0){dropdown.removeClass("hide");if(dropdown.find(".active").length==1){dropdown.addClass("active")}else{dropdown.removeClass("active")}}else{dropdown.addClass("hide")}}};
